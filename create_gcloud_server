# Создайте виртуальную машину для CA
# Я использовал регион sia-east1-b, вы же можете использовать любой другой регион. Все команды нужно выполнять внутри VM
gcloud compute instances create easy-rsa --zone=asia-east1-b --machine-type=e2-medium

# Коннектимся к нашей машине
gcloud compute ssh easy-rsa --zone=asia-east1-b

# Установите easy-rsa
sudo apt-get update
sudo apt-get install easy-rsa

# Создаем каталог easy-rsa
mkdir ~/easy-rsa

# Создаем ссылку на нашу папку
ln -s /usr/share/easy-rsa/* ~/easy-rsa/
# Установим права на папку
chmod 700 ~/easy-rsa/

# Перейдем в папку и скопируем файл var и настроим переменные
cd easy-rsa/
./easyrsa init-pki
cp vars.example vars
vim vars
# В этом файле нужно изменить следующие параметры
set_var EASYRSA_REQ_COUNTRY "RUS"
set_var EASYRSA_REQ_PROVINCE "Moscow"
set_var EASYRSA_REQ_CITY "Moscow City"
set_var EASYRSA_REQ_ORG "Our Company Name"
set_var EASYRSA_REQ_EMAIL "sysadmin@company.ru"
set_var EASYRSA_REQ_OU "LLC"
set_var EASYRSA_ALGO "ec"
set_var EASYRSA_DIGEST "sha512"
# Далее запустите скрипт easyrsa в командной строке:
./easyrsa build-ca
# Здесь необходимо будет ввести парольную фразу, которую впоследствии нужно
# вводить для получения доступа к вашему ЦС при совершении операций с
# сертификатами.
# Также система предложит вам ввести Common Name — обозначение вашего ЦС. Вы
# можете ввести любую символьную строку или принять дефолтное имя, нажав Enter.

# Сгенерируем сертификат для VPN Сервера
cd ~/easy-rsa
./easyrsa gen-req server nopass
# Подписываем сетрификат
./easyrsa sign-req server server

Для удобства скопируйте файл ca.crt в 1 директорию с ключом server 
 sudo cp /home/$USER/easy-rsa/pki/ca.crt /home/$USER/easy-rsa/pki/issued/
ls /home/murzabulatovberik/easy-rsa/pki/issued/ ---> 2 файла

# Нужно скопировать эти файлы на удаленный сервер VPN
gcloud compute ssh easy-rsa --zone=asia-east1-b --command="sudo cat /home/$USER/easy-rsa/pki/issued/ca.crt" > /home/$USER/Desktop/YOURFOLDER/ca.crt
gcloud compute ssh easy-rsa --zone=asia-east1-b --command="sudo cat /home/$USER/easy-rsa/pki/issued/server.crt" > /home/$USER/Desktop/YOURFOLDER/server.crt
# Копируем на VPN сервер
cat /home/$USER/Desktop/skillbox/ca.crt | gcloud compute ssh vpn-server-01 --zone=asia-east1-b --command="sudo tee /etc/openvpn/server/ca.crt > /dev/null"
cat /home/$USER/Desktop/skillbox/server.crt | gcloud compute ssh vpn-server-01 --zone=asia-east1-b --command="sudo tee /etc/openvpn/server/server.crt > /dev/null"

# Следующий шаг установка OPENVPN сервера


















# Обычно затем директорию с easy-rsa копируют в конфигурационную папку OpenVPN, но на наш взгляд CA лучше располагать отдельно, 
# поэтому мы скопируем директорию просто в /etc, однако это ни не что не влияет, и вы можете поступить по своему разумению.
sudo cp -r /usr/share/easy-rsa /etc
cd /etc/easy-rsa

# Прежде всего скопируем шаблон файла настроек:
cp vars.example vars 
#и откроем файл vars на редактирование. Строки вида #set_var содержат значения по умолчанию, для их именения строку нужно раскомментировать и указать собственное значение. 
#Начнем с опции EASYRSA_DN, она предусматривает два режима: упрощенный cn_only, при котором сертификат содержит только CN (имя того, кому выдан сертификат) и традиционный org, 
#при котором заполняются все реквизиты организации. Для OpenVPN можно использовать любой режим. Мы установим традиционный:

set_var EASYRSA_DN  "org"

#После чего раскомментируйте и заполните блок ниже своими данными (в примере указаны наши):
set.var EASYRSA_REQ_COUNTRY "RU"
set.var EASYRSA_REQ_PROVINCE "31"
set.var EASYRSA_REQ_CITY "BELGOROD"
set.var EASYRSA_REQ_ORG "Interface LLC"
set_var EASYRSA_REQ_EMAIL "admin@example.org"
set.var EASYRSA_REQ_OU "IT"
#Заметьте, что если вы оставили cn_only, то редактировать вышеуказанные опции не имеет смысла.
#Параметр EASYRSA_KEY_SIZE указывает размер ключа, на сегодняшний день безопасным считается размер начиная с 2048, если вы ставите на первое место безопасность, то можете увеличить его до 3072 или 4096. 
#Если криптографическая стойкость не играет роли, например, туннель будет использован для доступа в интернет и предполагается использование слабых устройств, то можно уменьшить размер ключа до 1024.

#Теперь инициализируем наш CA и выпустим корневую пару ключей. Обратите внимание, ч
#то данные действия следует выполнять единожды, повторное выполнение указанных команд уничтожит существующий CA и потребует повторного создания всех ключей и сертификатов.
sudo ./easyrsa init-pki

# Данная команда инициализирует новую структуру центра сертификации с очисткой всех данных. После чего создадим файл для генерации случайных данных:
sudo touch pki/.rnd
# и активируем наш CA:
sudo ./easyrsa build-ca
# После выполнения этих команд будет выполнено создание структуры директорий CA, публичный сертификат центра сертификации ca.crt вы сможете найти в директории pki, 
#а закрытый ключ ca.key в pki/private. Закрытый ключ является секретным и не при каких обстоятельствах не должен покидать свое расположение и тем более не должен передаваться по открытым каналам связи, 
#доступ третьих лиц к закрытому ключу также следует ограничить.
#Также не забудем сформировать файл параметров Диффи-Хеллмана dh.pem, он также будет расположен в директории pki:
sudo ./easyrsa gen-dh

# Создание ключа и сертификата для сервера
./easyrsa gen-req ovpn-server nopass

# Для выпуска сертификата выполните:
sudo ./easyrsa sign-req server ovpn-server

# Теперь скопируем необходимые сертификаты и ключи в директорию OpenVPN, предварительно создав там папку keys:
sudo mkdir /etc/openvpn/keys
sudo cp pki/ca.crt pki/dh.pem /etc/openvpn/keys
sudo cp pki/private/ovpn-server.key pki/issued/ovpn-server.crt /etc/openvpn/keys
# В итогу у вас в конечной папке должно 4 файла ca.crt  dh.pem  ovpn-server.crt  ovpn-server.key которые мы пердадим в OpenVPN-server

# Селдующий этап у вас создание OpenVPN сервера

